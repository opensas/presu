/*!
 * BubbleTree 2.0.1
 *
 * Copyright (c) 2011 Gregor Aisch (http://driven-by-data.net)
 * Licensed under the MIT license
 *
 *//*jshint undef: true, browser:true, jquery: true, devel: true, smarttabs: true *//*global Raphael, TWEEN, vis4, vis4color, vis4loader */var BubbleTree=function(e,t,n){var r=this;r.version="2.0.2",r.$container=$(e.container),r.config=$.extend({rootPath:"",minRadiusLabels:40,minRadiusAmounts:20,minRadiusHideLabels:0,cutLabelsAt:50},e),r.tooltip=e.tooltipCallback?e.tooltipCallback:function(){},e.tooltip&&(r.tooltip=e.tooltip),r.style=e.bubbleStyles,r.ns=BubbleTree,r.nodesByUrlToken={},r.nodeList=[],r.iconsByUrlToken={},r.globalNodeCounter=0,r.displayObjects=[],r.bubbleScale=1,r.globRotation=0,r.currentYear=e.initYear,r.currentCenter=undefined,r.currentTransition=undefined,r.baseUrl="",r.loadData=function(e){$.ajax({url:e,dataType:"json",success:this.setData.bind(this)})},r.setData=function(e){var t=this;e||(e=t.config.data),t.initData(e),t.initPaper(),t.initBubbles(),t.initTween(),t.initHistory()},r.initData=function(e){var t=this;e.level=0,t.preprocessData(e),t.traverse(e,0),t.treeRoot=e},r.preprocessData=function(e){var t=this,n=t.config.maxNodesPerLevel;if(n&&n<e.children.length){var r=t.sortChildren(e.children);r.reverse();var i=[],s=[],o=0,u;for(var a in e.children)a<n?i.push(e.children[a]):(s.push(e.children[a]),o+=Math.max(0,e.children[a].amount));e.children=i,e.children.push({label:"More",name:"more",amount:o,children:s,breakdown:u})}},r.traverse=function(e,t){var n,r,i,s=this,o,u=s.config.bubbleStyles;e.children||(e.children=[]),s.nodeList.push(e),e.famount=s.ns.Utils.formatNumber(e.amount),e.parent&&(e.level=e.parent.level+1),s.config.clearColors===!0&&(e.color=!1);if(u){var a=["color","shortLabel","icon"];$.each(a,function(t,n){u.hasOwnProperty("id")&&u.id.hasOwnProperty(e.id)&&u.id[e.id].hasOwnProperty(n)?e[n]=u.id[e.id][n]:e.hasOwnProperty("name")&&u.hasOwnProperty("name")&&u.name.hasOwnProperty(e.name)&&u.name[e.name].hasOwnProperty(n)?e[n]=u.name[e.name][n]:e.hasOwnProperty("taxonomy")&&u.hasOwnProperty(e.taxonomy)&&u[e.taxonomy].hasOwnProperty(e.name)&&u[e.taxonomy][e.name].hasOwnProperty(n)&&(e[n]=u[e.taxonomy][e.name][n])})}e.color||(e.level>0?e.color=e.parent.color:e.color="#999999"),e.children.length<2&&e.color&&(e.color=vis4color.fromHex(e.color).saturation("*.86").x),e.level>0&&(i=e.parent.children,i.length>1&&(e.left=i[(t-1+i.length)%i.length],e.right=i[(Number(t)+1)%i.length],e.right==e.left&&(e.right=undefined))),e.label!==undefined&&e.label!==""?o=e.label:e.token!==undefined&&e.token!==""?o=e.token:o=""+s.globalNodeCounter,s.globalNodeCounter++,e.urlToken=o.toLowerCase().replace(/\W/g,"-");while(s.nodesByUrlToken.hasOwnProperty(e.urlToken))e.urlToken+="-";s.nodesByUrlToken[e.urlToken]=e,e.maxChildAmount=0,e.children=s.sortChildren(e.children,!0,s.config.sortBy),$.each(e.children,function(t,n){n.parent=e,e.maxChildAmount=Math.max(e.maxChildAmount,n.amount),s.traverse(n,t)}),e.breakdowns&&(e.breakdownsByName={},$.each(e.breakdowns,function(t,n){n.famount=s.ns.Utils.formatNumber(n.amount),n.name&&(e.breakdownsByName[n.name]=n)}))},r.sortChildren=function(e,t,n){var i=[],s=!0;n=="label"?(n=r.compareLabels,t=!1):n=r.compareAmounts,e.sort(n);if(t){while(e.length>0)i.push(s?e.pop():e.shift()),s=!s;return i}return e},r.compareAmounts=function(e,t){return e.amount>t.amount?1:e.amount==t.amount?0:-1},r.compareLabels=function(e,t){return e.label>t.label?1:e.label==t.label?0:-1},r.initPaper=function(){var e=this,t=e.$container,n=e.treeRoot,r=t.width(),i=t.height(),s=Raphael(t[0],r,i),o=Math.min(r,i)*.5-40,u,a=e.ns.Vector,f=new a(r*.5,i*.5);e.width=r,e.height=i,e.paper=s,u=Math.pow((Math.pow(n.amount,.6)+Math.pow(n.maxChildAmount,.6)*2)/o,1.6666666667),e.a2radBase=e.ns.a2radBase=u,e.origin=f,$(window).resize(e.onResize.bind(e))},r.onResize=function(){var e=this,t=e.$container,n=t.width(),r=t.height(),i=Math.min(n,r)*.5-40,s,o=e.treeRoot,u,a;e.paper.setSize(n,r),e.origin.x=n*.5,e.origin.y=r*.5,e.width=n,e.height=r,s=Math.pow((Math.pow(o.amount,.6)+Math.pow(o.maxChildAmount,.6)*2)/i,1.6666666667),e.a2radBase=e.ns.a2radBase=s,$.each(e.displayObjects,function(t,n){n.className=="bubble"&&(n.bubbleRad=e.ns.Utils.amount2rad(n.node.amount))}),e.currentCenter&&e.changeView(e.currentCenter.urlToken)},r.initTween=function(){this.tweenTimer=setInterval(this.loop,1e3/120)},r.initBubbles=function(){var e=this,t=e.treeRoot,n,r=!1,i=e.ns.Bubbles,s;e.bubbleClasses=[],e.config.hasOwnProperty("bubbleType")||(e.config.bubbleType=["plain"]),$.isArray(e.config.bubbleType)||(e.config.bubbleType=[e.config.bubbleType]),$.isArray(e.config.bubbleType)&&$.each(e.config.bubbleType,function(t){e.config.bubbleType[t]=="icon"&&(r=!0),e.bubbleClasses.push(e.getBubbleType(e.config.bubbleType[t]))});var o=e.createBubble(t,e.origin,0,0,t.color);e.traverseBubbles(o)},r.getBubbleType=function(e){var t=this,n=t.ns.Bubbles;switch(e){case"pie":return n.Pies;case"donut":return n.Donut;case"multi":return n.Multi;case"icon":return n.Icon;default:return n.Plain}},r.traverseBubbles=function(e){var t=this,n,r=t.ns.Utils.amount2rad,i,s,o,u,a=0,f=0,l,c,h=Math.PI*2;o=e.node.children,$.each(o,function(e,t){a+=r(t.amount)}),o.length>0&&(n=t.createRing(e.node,e.pos,0,{stroke:"#888","stroke-dasharray":"-"})),$.each(o,function(n,i){l=r(i.amount)/a*h,c=f+l*.5,isNaN(c)&&vis4.log(f,l,i.amount,a,h),i.centerAngle=c,u=t.createBubble(i,e.pos,0,c,i.color),f+=l,t.traverseBubbles(u)})},r.createBubble=function(e,t,n,r,i){var s=this,o=s.ns,u,a,f,l=e.level;return isNaN(l)&&(l=0),l=Math.min(l,s.bubbleClasses.length-1),f=new s.bubbleClasses[l](e,s,t,n,r,i),s.displayObjects.push(f),f},r.createRing=function(e,t,n,r){var i=this,s=i.ns,o;return o=new s.Ring(e,i,t,n,r),i.displayObjects.push(o),o},r.changeView=function(e){var t=this,n=t.paper,r=Math.min(t.width,t.height)*.35,i=t.ns,s=i.Utils,o=t.origin,u={stroke:"#ccc","stroke-dasharray":"- "},a={stroke:"#ccc","stroke-dasharray":". "},f=s.amount2rad,l=t.treeRoot,c=t.nodesByUrlToken,h=c.hasOwnProperty(e)?c[e]:null,p=new i.Layout,d,v,m,g=Math.PI*2,y=t.getBubble.bind(t),b=t.getRing.bind(t),w=t.unifyAngle;if(h!==null){var E,S,x,T,N,C,k,L,A,O,M,_,D,P=!1,H=!1;for(m in t.displayObjects)t.displayObjects[m].hideFlag=!0;if(h==l||h.parent==l&&h.children.length<2){p.$(t).bubbleScale=1,p.$(o).x=t.width*.5,p.$(o).y=t.height*.5,E=y(l),h!=l&&(E.childRotation=-h.centerAngle),C=f(l.amount)+f(l.maxChildAmount)+20,M=b(l),p.$(M).rad=C;for(m in l.children)N=l.children[m],d=y(N),p.$(d).angle=w(N.centerAngle+E.childRotation),p.$(d).rad=C}else{var B=h;h.children.length<2&&(h=h.parent),_=r/(f(h.amount)+f(h.maxChildAmount)*2),p.$(t).bubbleScale=_,E=y(h),t.currentCenter&&t.currentCenter==h.left?H=!0:t.currentCenter&&t.currentCenter==h.right&&(P=!0);var j=t.shortestAngleTo;p.$(E).angle=j(E.angle,0),C=(f(h.amount)+f(h.maxChildAmount))*_+20,M=b(h),p.$(M).rad=C,S=y(h.parent),S.childRotation=-h.centerAngle;var F=S;while(F&&F.node.parent)F=y(F.node.parent,!0),p.$(F).rad=0;p.$(S).rad=0;var I=t.width*.5;k=0-Math.max(I*.8-_*(f(h.parent.amount)+f(Math.max(h.amount*1.15+h.maxChildAmount*1.15,h.left.amount*.85,h.right.amount*.85))),_*f(h.parent.amount)*-1+I*.15)+I;if(h.left&&h.right)var q=_*f(Math.max(h.left.amount,h.right.amount));D=C+k,p.$(o).x=t.width*.5-k-(h!=B?C*.35:0),p.$(o).y=t.height*.5,new vis4.DelayedTask(1500,vis4,vis4.log,o,S.pos),k+=t.width*.1,M=b(h.parent),p.$(M).rad=k,p.$(E).rad=k;var R=0-(h!=B?B.centerAngle+E.childRotation:0);for(m in h.children)N=h.children[m],d=y(N),p.$(d).angle=t.shortestAngleTo(d.angle,N.centerAngle+E.childRotation+R),p.$(d).rad=C;var U=t.height*.07;h.left&&(x=h.left,A=f(x.amount)*_,O=g-Math.asin((t.paper.height*.5+A-U)/k),d=y(x),p.$(d).rad=k,p.$(d).angle=j(d.angle,O)),h.right&&(x=h.right,A=f(x.amount)*_,O=Math.asin((t.paper.height*.5+A-U)/k),d=y(x),p.$(d).rad=k,p.$(d).angle=j(d.angle,O)),h=B}for(m in t.displayObjects){var z=t.displayObjects[m];z.hideFlag&&z.visible?(p.$(z).alpha=0,z.className=="bubble"&&z.node.level>1&&(p.$(z).rad=0),p.hide(z)):z.hideFlag||(p.$(z).alpha=1,z.visible||(z.alpha=0,p.show(z)))}v=new i.Transitioner($.browser.msie||t.currentCenter==h?0:1e3),v.changeLayout(p),t.currentTransition=v,!t.currentCenter&&$.isFunction(t.config.firstNodeCallback)&&t.config.firstNodeCallback(h),t.currentCenter=h}else s.log("node "+e+" not found")},r.unifyAngle=function(e){var t=Math.PI,n=t*2;while(e>=n)e-=n;while(e<0)e+=n;return e},r.shortestAngle=function(e,t){var n=function(e){return Math.round(e/Math.PI*180)+""},i=Math.PI,s=i*2,o=r.unifyAngle;e=o(e),t=o(t);var u=t-e;return u>i&&(u-=s),u<-i&&(u+=s),u},r.shortestAngleTo=function(e,t){return e+r.shortestAngle(e,t)},r.shortestLeftTurn=function(e,t){var n=r.shortestAngle(e,t);return n>0&&(n-=Math.PI*2),e+n},r.shortestRightTurn=function(e,t){var n=r.shortestAngle(e,t);return n<0&&(n=Math.PI*2+n),e+n},r.getBubble=function(e,t){return this.getDisplayObject("bubble",e,t)},r.getRing=function(e){return this.getDisplayObject("ring",e)},r.getDisplayObject=function(e,t,n){var r=this,i,s;for(i in r.displayObjects){s=r.displayObjects[i];if(s.className!=e)continue;if(s.node==t)return n||(s.hideFlag=!1),s}vis4.log(e+" not found for node",t)},r.initHistory=function(){$.history.init(r.urlChanged.bind(r),{unescape:",/"})},r.freshUrl="",r.urlChanged=function(e){var t=this,n=t.currentTransition;t.freshUrl||e.indexOf("/~/")&&(t.baseUrl=e.substr(0,e.indexOf("/~/"))),t.freshUrl=e,n&&n.running?(vis4.log("transition is running at the moment, adding listener"),n.onComplete(t.changeUrl.bind(t))):t.changeUrl()},r.changeUrl=function(){var e=this,t=e.freshUrl.split("/"),n=t[t.length-1],r;e.freshUrl===""&&e.navigateTo(e.treeRoot),e.nodesByUrlToken.hasOwnProperty(n)?(r=e.getUrlForNode(e.nodesByUrlToken[n]),e.freshUrl!=r?$.history.load(r):e.navigateTo(e.nodesByUrlToken[n],!0)):e.navigateTo(e.treeRoot)},r.navigateTo=function(e,t){var n=this;t?n.changeView(e.urlToken):$.history.load(n.getUrlForNode(e)),$(".label, .label2",n.$container).removeClass("current"),$(".label2."+e.id,n.$container).addClass("current"),$(".label."+e.id,n.$container).addClass("current")},r.getUrlForNode=function(e){var t=[];t.push(e.urlToken);while(e.parent)t.push(e.parent.urlToken),e=e.parent;return t.reverse(),r.baseUrl+"/~/"+t.join("/")},r.onNodeClick=function(e){$.isFunction(r.config.nodeClickCallback)&&r.config.nodeClickCallback(e)},r.clean=function(){var e=this,t;$(".label").remove()},this.loop=function(){TWEEN.update()};if(!r.config.hasOwnProperty("data"))throw new Error("no data");typeof r.config.data=="string"?r.loadData():new vis4.DelayedTask(1e3,r,r.setData,r.config.data)};BubbleTree.Styles={},BubbleTree.Layout=function(){var e=this;e.objects=[],e.props=[],e.toHide=[],e.toShow=[],e.$=function(e){var t=this,n,r,i;for(n in t.objects){r=t.objects[n];if(r==e)return t.props[n]}return t.objects.push(e),i={},t.props.push(i),i},e.show=function(e){var t=this;t.toShow.push(e)},e.hide=function(e){var t=this;t.toHide.push(e)}},BubbleTree.Line=function(e,t,n,r,i,s){this.bc=e,this.o=n,this.angle=r,this.fromRad=i,this.attr=t,this.toRad=s,this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad,this.y1=this.o.y-Math.sin(this.angle)*this.fromRad,this.x2=this.o.x+Math.cos(this.angle)*this.toRad,this.y2=this.o.y-Math.sin(this.angle)*this.toRad},this.init=function(){this.getXY(),console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,t),this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)},this.draw=function(){this.getXY(),this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})},this.init()},BubbleTree.Loader=function(e){var t=this;t.config=e,t.ns=BubbleTree,t.loadData=function(){var e=this,t=e.config.data;console.log("loading url ",t),$.ajax({url:t,context:e,dataType:"json",success:function(e){this.run(e)}})},t.run=function(e){var t=this,n=new BubbleTree(t.config);n.setData(e),t.config.instance=n},!t.config.hasOwnProperty("data"),typeof t.config.data=="string"?t.loadData():t.run(t.config.data)},BubbleTree.MouseEventGroup=function(e,t){var n=this;n.target=e,n.members=t,n.click=function(e){var t=this,n=t.members,r,i;t.clickCallback=e;for(r in n)i=n[r],$(i).click(t.handleClick.bind(t))},n.handleClick=function(e){var t=this;t.clickCallback({target:t.target,origEvent:e,mouseEventGroup:t})},n.hover=function(e){var t=this,n=t.members,r,i;t.hoverCallback=e;for(r in n)i=n[r],$(i).hover(t.handleMemberHover.bind(t),t.handleMemberUnHover.bind(t))},n.unhover=function(e){var t=this;t.unhoverCallback=e},n.wasHovering=!1,n.mouseIsOver=!1,n.handleMemberHover=function(e){var t=this;new vis4.DelayedTask(25,t,t.handleMemberHoverDelayed,e)},n.handleMemberHoverDelayed=function(e){var t=this;t.mouseIsOver=!0,t.wasHovering||(t.wasHovering=!0,$.isFunction(t.hoverCallback)&&t.hoverCallback({target:t.target,origEvent:e,mouseEventGroup:t}))},n.handleMemberUnHover=function(e){var t=this;t.mouseIsOver=!1,new vis4.DelayedTask(40,t,t.handleMemberUnHoverDelayed,e)},n.handleMemberUnHoverDelayed=function(e){var t=this;t.mouseIsOver||(t.wasHovering=!1,$.isFunction(t.unhoverCallback)&&t.unhoverCallback({target:t.target,origEvent:e,mouseEventGroup:t}))},n.addMember=function(e){var t=this;t.hoverCallback&&$(e).hover(t.handleMemberHover.bind(t),t.handleMemberUnHover.bind(t)),t.members.push(e)},n.removeMember=function(e){var t=this,n=t.members,r,i=[];t.clickCallback&&$(e).unbind("click"),t.hoverCallback&&$(e).unbind("mouseenter mouseleave");for(r in n)n[r]!=e&&i.push(n[r]);t.members=i}},BubbleTree.Ring=function(e,t,n,r,i){var s=this;s.className="ring",s.rad=r,s.bc=t,s.attr=i,s.origin=n,s.alpha=1,s.visible=!1,s.node=e,s.init=function(){},s.draw=function(){var e=this,t=e.origin;if(!e.visible)return;e.circle.attr({cx:t.x,cy:t.y,r:e.rad,"stroke-opacity":e.alpha})},s.hide=function(){var e=this;e.circle.remove(),e.visible=!1},s.show=function(){var e=this;e.circle=e.bc.paper.circle(n.x,n.y,e.rad).attr(e.attr),e.visible=!0,e.circle.toBack()},s.init()},BubbleTree.Transitioner=function(e){var t=this;t.duration=e,t.running=!1,t.completeCallbacks=[],t.changeLayout=function(e){var t,n,r,i,s=this;s.running=!0,s.layout=e;for(t in e.toShow)n=e.toShow[t],$.isFunction(n.show)&&n.show();for(t in e.objects){n=e.objects[t];if(n===undefined||n===null)continue;r=e.props[t];if(s.duration>0){var o=new TWEEN.Tween(n),u={};for(i in r)u[i]=r[i];o.to(u,s.duration),o.easing(TWEEN.Easing.Exponential.EaseOut),$.isFunction(n.draw)&&o.onUpdate(n.draw.bind(n)),t==e.objects.length-1&&o.onComplete(s._completed.bind(s)),o.start()}else{for(i in r)n[i]=r[i];n&&$.isFunction(n.draw)&&n.draw()}}if(s.duration===0){for(t in e.objects)n=e.objects[t],n&&$.isFunction(n.draw)&&n.draw();s._completed()}},t.onComplete=function(e){var t=this;try{$.isFunction(e)&&t.completeCallbacks.push(e)}catch(n){}},t._completed=function(){var e=this,t=e.completeCallbacks,n,r;e.running=!1;for(n in e.layout.objects)r=e.layout.objects[n],r&&$.isFunction(r.draw)&&r.draw();for(n in e.layout.toHide)r=e.layout.toHide[n],r&&$.isFunction(r.hide)&&r.hide();for(n in t)t[n]()}},BubbleTree.Utils={},BubbleTree.Utils.log=function(){try{window.hasOwnProperty("console")&&console.log.apply(this,arguments)}catch(e){}},BubbleTree.Utils.amount2rad=function(e){return Math.pow(Math.max(0,e)/BubbleTree.a2radBase,.6)},BubbleTree.Utils.formatNumber=function(e){var t="";return e<0&&(e*=-1,t="-"),e>=1e12?t+Math.round(e/1e11)/10+"t":e>=1e9?t+Math.round(e/1e8)/10+"b":e>=1e6?t+Math.round(e/1e5)/10+"m":e>=1e3?t+Math.round(e/100)/10+"k":t+e},BubbleTree.Vector=function(e,t){var n=this;n.x=e,n.y=t,n.length=function(){var e=this;return Math.sqrt(e.x*e.x+e.y*e.y)},n.normalize=function(e){var t=this,n=t.length();e||(e=1),t.x*=e/n,t.y*=e/n},n.clone=function(){var e=this;return new BubbleTree.Vector(e.x,e.y)}},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Plain=function(e,t,n,r,i,s){var o=BubbleTree,u=o.Utils,a=this;a.className="bubble",a.node=e,a.paper=t.paper,a.origin=n,a.bc=t,a.rad=r,a.angle=i,a.color=s,a.alpha=1,a.visible=!1,a.ns=o,a.pos=o.Vector(0,0),a.bubbleRad=u.amount2rad(this.node.amount),a.container=a.bc.$container,a.childRotation=0,a.getXY=function(){var e=this,t=e.origin,n=e.angle,r=e.rad;e.pos===undefined&&(e.pos=new e.ns.Vector(0,0)),e.pos.x=t.x+Math.cos(n)*r,e.pos.y=t.y-Math.sin(n)*r},a.init=function(){var e=this;e.getXY();var t=!1;e.node.shortLabel||(e.node.shortLabel=e.node.label.length>e.bc.config.cutLabelsAt+3?e.node.label.substr(0,e.bc.config.cutLabelsAt)+"...":e.node.label),e.initialized=!0},a.onclick=function(e){var t=this;t.bc.onNodeClick(t.node),t.bc.navigateTo(t.node)},a.onhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.target=t,e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},e.type="SHOW",t.bc.tooltip(e)},a.onunhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.type="HIDE",e.target=t,e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},t.bc.tooltip(e)},a.draw=function(){var e=this,t=Math.max(5,e.bubbleRad*e.bc.bubbleScale),n=e.pos.x,r=e.pos.y,i=e.getXY(),s=e.pos.x,o=e.pos.y;if(!e.visible)return;e.circle.attr({cx:e.pos.x,cy:e.pos.y,r:t,"fill-opacity":e.alpha}),e.node.children.length>1?e.dashedBorder.attr({cx:e.pos.x,cy:e.pos.y,r:t-4,"stroke-opacity":e.alpha*.9}):e.dashedBorder.attr({"stroke-opacity":0}),e.label.show(),e.label.find("*").show(),e.label2.show(),t>=e.bc.config.minRadiusLabels?e.label2.hide():t>=e.bc.config.minRadiusAmounts?e.label.find(".desc").hide():t>=e.bc.config.minRadiusHideLabels?e.label.hide():(e.label.hide(),e.label2.hide()),e.label.css({width:2*t+"px",opacity:e.alpha}),e.label.css({left:e.pos.x-t+"px",top:e.pos.y-e.label.height()*.5+"px"});var u=Math.max(70,3*t);e.label2.css({width:u+"px",opacity:e.alpha}),e.label2.css({left:s-u*.5+"px",top:o+t+"px"})},a.hide=function(){var e=this,t;e.circle.remove(),e.dashedBorder.remove(),e.label.remove(),e.label2.remove(),e.visible=!1},a.show=function(){var e=this,t,n=e.pos.x,r=e.pos.y,i=Math.max(5,e.bubbleRad*e.bc.bubbleScale);e.circle=e.paper.circle(n,r,i).attr({stroke:!1,fill:e.color}),e.dashedBorder=e.paper.circle(n,r,i-3).attr({stroke:"#ffffff","stroke-dasharray":"- "}),e.label=$('<div class="label '+e.node.id+'"><div class="amount">'+u.formatNumber(e.node.amount)+'</div><div class="desc">'+e.node.shortLabel+"</div></div>"),e.container.append(e.label),e.node.children.length>0&&($(e.circle.node).css({cursor:"pointer"}),$(e.label).css({cursor:"pointer"})),e.label2=$('<div class="label2 '+e.node.id+'"><span>'+e.node.shortLabel+"</span></div>"),e.container.append(e.label2);var s=[e.circle.node,e.label,e.dashedBorder.node],o=new e.ns.MouseEventGroup(e,s);o.click(e.onclick.bind(e)),o.hover(e.onhover.bind(e)),o.unhover(e.onunhover.bind(e)),e.visible=!0},a.addOverlay=function(){var e=this;e.overlay=e.paper.circle(e.circle.attrs.cx,e.circle.attrs.cy,e.circle.attrs.r).attr({stroke:!1,fill:"#fff",opacity:0}),Raphael.svg&&e.overlay.node.setAttribute("class",e.node.id),$(e.overlay.node).css({cursor:"pointer"}),$(e.overlay.node).click(e.onclick.bind(e)),$(e.label).click(e.onclick.bind(e))},a.init()},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Donut=function(e,t,n,r,i,s){var o=BubbleTree,u=o.Utils,a=this;a.className="bubble",a.node=e,a.paper=t.paper,a.origin=n,a.bc=t,a.rad=r,a.angle=i,a.color=s,a.alpha=1,a.visible=!1,a.ns=o,a.bubbleRad=u.amount2rad(this.node.amount),a.childRotation=0,a.getXY=function(){var e=this,t=e.origin,n=e.angle,r=e.rad;e.pos.x=t.x+Math.cos(n)*r,e.pos.y=t.y-Math.sin(n)*r},a.init=function(){var e=this;e.pos=new e.ns.Vector(0,0),e.getXY();var t=[],n,r,i,s=[],o=e.bc.config.bubbleStyles;e.node.shortLabel||(e.node.shortLabel=e.node.label.length>50?e.node.label.substr(0,30)+"...":e.node.label),e.breakdownOpacities=[.2,.7,.45,.6,.35],e.breakdownColors=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(r in e.node.breakdowns)n=e.node.breakdowns[r],n.famount=u.formatNumber(n.amount),i=n.amount/e.node.amount,t.push(i),s.push(n),o&&o.hasOwnProperty("name")&&o.name.hasOwnProperty(n.name)&&o.name[n.name].hasOwnProperty("opacity")&&(e.breakdownOpacities[s.length-1]=o.name[n.name].opacity),o&&o.hasOwnProperty("name")&&o.name.hasOwnProperty(n.name)&&o.name[n.name].hasOwnProperty("color")&&(e.breakdownColors[s.length-1]=o.name[n.name].color,e.breakdownOpacities[s.length-1]=1);e.node.breakdowns=s,e.breakdown=t;var a=!1;e.initialized=!0},a.onclick=function(e){var t=this;t.bc.navigateTo(t.node)},a.onhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.target=t,e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},e.type="SHOW",t.bc.tooltip(e)},a.onunhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.target=t,e.type="HIDE",e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},t.bc.tooltip(e)},this.draw=function(){var e=this,t=Math.max(5,e.bubbleRad*e.bc.bubbleScale),n=e.pos.x,r=e.pos.y,i=e.getXY(),s=t>20,o=e.pos.x,u=e.pos.y;if(!e.visible)return;e.circle.attr({cx:o,cy:u,r:t,"fill-opacity":e.alpha}),e.node.children.length>1?e.dashedBorder.attr({cx:o,cy:u,r:t*.85,"stroke-opacity":e.alpha*.8}):e.dashedBorder.attr({"stroke-opacity":0});if(e.breakdown.length>1){var a,f,l,c,h,p,d,v,m,g=t*.85,y=-Math.PI*.5,b;for(a in e.breakdown){b=e.breakdown[a]*Math.PI*2,f=o+Math.cos(y)*g,p=u+Math.sin(y)*g,l=o+Math.cos(y+b)*g,d=u+Math.sin(y+b)*g,c=o+Math.cos(y+b)*t,v=u+Math.sin(y+b)*t,h=o+Math.cos(y)*t,m=u+Math.sin(y)*t,y+=b;var w="M"+f+" "+p+" A"+g+","+g+" 0 "+(b>Math.PI?"1,1":"0,1")+" "+l+","+d+" L"+c+" "+v+" A"+t+","+t+" 0 "+(b>Math.PI?"1,0":"0,0")+" "+h+" "+m+" Z";e.breakdownArcs[a].attr({path:w,"stroke-opacity":e.alpha*.2,"fill-opacity":e.breakdownOpacities[a]*e.alpha})}}s?(e.label.show(),t<40?(e.label.find(".desc").hide(),e.label2.show()):(e.label.find(".desc").show(),e.label2.hide())):(e.label.hide(),e.label2.show()),e.label.css({width:2*t*.9+"px",opacity:e.alpha}),e.label.css({left:e.pos.x-t*.9+"px",top:e.pos.y-e.label.height()*.53+"px"});var E=Math.max(80,3*t);e.label2.css({width:E+"px",opacity:e.alpha}),e.label2.css({left:o-E*.5+"px",top:u+t+"px"})},this.hide=function(){var e=this,t;e.circle.remove(),e.dashedBorder.remove(),e.label.remove(),e.label2.remove(),e.visible=!1;for(t in e.breakdownArcs)e.breakdownArcs[t].remove()},a.show=function(){var e=this,t,n=Math.max(5,e.bubbleRad*e.bc.bubbleScale);e.circle=e.paper.circle(e.pos.x,e.pos.y,n).attr({stroke:!1,fill:e.color}),$.isFunction(e.bc.config.initTooltip)&&e.bc.config.initTooltip(e.node,e.circle.node),e.dashedBorder=e.paper.circle(e.pos.x,e.pos.y,n*.85).attr({stroke:"#fff","stroke-opacity":e.alpha*.4,"stroke-dasharray":". ",fill:!1}),e.label=$('<div class="label '+e.node.id+'"><div class="amount">'+u.formatNumber(e.node.amount)+'</div><div class="desc">'+e.node.shortLabel+"</div></div>"),e.bc.$container.append(e.label),e.node.children.length>1&&($(e.circle.node).css({cursor:"pointer"}),$(e.label).css({cursor:"pointer"})),e.label2=$('<div class="label2 '+e.node.id+'"><span>'+e.node.shortLabel+"</span></div>"),e.bc.$container.append(e.label2);var r=[e.circle.node,e.label];if(e.breakdown.length>1){e.breakdownArcs={};for(t in e.breakdown){var i=e.breakdownColors[t]?e.breakdownColors[t]:"#fff",s=e.paper.path("M 0 0 L 2 2").attr({fill:i,"fill-opacity":Math.random()*.4+.3,stroke:"#fff"});e.breakdownArcs[t]=s,$.isFunction(e.bc.config.initTooltip)&&e.bc.config.initTooltip(e.node.breakdowns[t],s.node)}for(t in e.breakdownArcs)$(e.breakdownArcs[t].node).click(e.onclick.bind(e))}var o=new e.ns.MouseEventGroup(e,r);o.click(e.onclick.bind(e)),o.hover(e.onhover.bind(e)),o.unhover(e.onunhover.bind(e)),e.visible=!0},a.arcHover=function(e){var t=this,n=t.bc.$container[0],r,i=t.breakdownArcs,s,o=t.node.breakdowns;for(r in i)if(i[r].node==e.target){e.node=o[r],e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.pageX-n.offsetLeft,y:e.pageY-n.offsetTop},e.target=t,e.type="SHOW",t.bc.tooltip(e);return}vis4.log("cant find the breakdown node")},a.arcUnhover=function(e){var t=this,n=t.bc.$container[0],r,i=t.breakdownArcs,s,o=t.node.breakdowns;for(r in i)if(i[r].node==e.target){e.node=o[r],e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.pageX-n.offsetLeft,y:e.pageY-n.offsetTop},e.type="HIDE",e.target=t,t.bc.tooltip(e);return}vis4.log("cant find the breakdown node")},a.init()},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Icon=function(e,t,n,r,i,s){var o=BubbleTree,u=o.Utils,a=this;a.className="bubble",a.node=e,a.paper=t.paper,a.origin=n,a.bc=t,a.rad=r,a.angle=i,a.color=s,a.alpha=1,a.visible=!1,a.ns=o,a.pos=o.Vector(0,0),a.bubbleRad=u.amount2rad(this.node.amount),a.iconLoaded=!1,a.childRotation=0,a.getXY=function(){var e=this,t=e.origin,n=e.angle,r=e.rad;e.pos===undefined&&(e.pos=new e.ns.Vector(0,0)),e.pos.x=t.x+Math.cos(n)*r,e.pos.y=t.y-Math.sin(n)*r},a.init=function(){var e=this;e.getXY(),e.hasIcon=e.node.hasOwnProperty("icon"),e.node.shortLabel||(e.node.shortLabel=e.node.label.length>50?e.node.label.substr(0,30)+"...":e.node.label),e.initialized=!0},a.show=function(){var e=this,t,n=e.pos.x,r,i=e.pos.y,s=Math.max(5,e.bubbleRad*e.bc.bubbleScale);e.circle=e.paper.circle(n,i,s).attr({stroke:!1,fill:e.color}),e.dashedBorder=e.paper.circle(n,i,Math.min(s-3,s*.95)).attr({stroke:"#ffffff","stroke-dasharray":"- "}),$.isFunction(e.bc.config.initTooltip)&&e.bc.config.initTooltip(e.node,e.circle.node),e.label=$('<div class="label '+e.node.id+'"><div class="amount">'+u.formatNumber(e.node.amount)+'</div><div class="desc">'+e.node.shortLabel+"</div></div>"),e.bc.$container.append(e.label),$.isFunction(e.bc.config.initTooltip)&&e.bc.config.initTooltip(e.node,e.label[0]),e.label2=$('<div class="label2 '+e.node.id+'"><span>'+e.node.shortLabel+"</span></div>"),e.bc.$container.append(e.label2),e.node.children.length>0&&($(e.circle.node).css({cursor:"pointer"}),$(e.label).css({cursor:"pointer"})),e.visible=!0,e.hasIcon?e.iconLoaded?e.displayIcon():e.loadIcon():e.addOverlay()},a.loadIcon=function(){var e=this,t=new vis4loader;t.add(e.bc.config.rootPath+e.node.icon),t.load(e.iconLoadComplete.bind(e))},a.iconLoadComplete=function(e){var t=this,n,r,i;n=e.items[0].data,t.iconPathData="",n=$(n),i=$("path",n);for(r in i)i[r]&&$.isFunction(i[r].getAttribute)&&(t.iconPathData+=String(i[r].getAttribute("d"))+" ");t.iconLoaded=!0,t.displayIcon()},a.displayIcon=function(){var e=this,t,n;e.iconPaths=[],n=e.paper.path(e.iconPathData),n.attr({fill:"#fff",stroke:"none"}).translate(-50,-50),e.iconPaths.push(n),e.addOverlay()},a.addOverlay=function(){var e=this;e.overlay=e.paper.circle(e.circle.attrs.cx,e.circle.attrs.cy,e.circle.attrs.r).attr({stroke:!1,fill:"#fff","fill-opacity":0}),Raphael.svg&&e.overlay.node.setAttribute("class",e.node.id),$(e.overlay.node).css({cursor:"pointer"}),$(e.overlay.node).click(e.onclick.bind(e)),$(e.label).click(e.onclick.bind(e)),$(e.label2).click(e.onclick.bind(e));if($.isPlainObject(e.bc.tooltip)){var t=e.bc.tooltip.content(e.node);$(e.overlay.node).qtip({position:{target:"mouse",viewport:$(window),adjust:{x:7,y:7}},show:{delay:e.bc.tooltip.delay||100},content:{title:t[0],text:t[1]}})}},a.removeIcon=function(){var e=this,t,n;for(t in e.iconPaths)e.iconPaths[t].remove();e.iconPaths=[]},a.draw=function(){var e=this,t=Math.max(5,e.bubbleRad*e.bc.bubbleScale),n=e.pos.x,r=e.pos.y,i=e.getXY(),s=e.pos.x,o=e.pos.y,u=e.hasIcon&&t>15,a=e.hasIcon?t>40:t>20,f,l,c,h,p;if(!e.visible)return;e.circle.attr({cx:s,cy:o,r:t,"fill-opacity":e.alpha}),e.overlay&&e.overlay.attr({cx:s,cy:o,r:Math.max(10,t)}),e.node.children.length>1?e.dashedBorder.attr({cx:e.pos.x,cy:e.pos.y,r:Math.min(t-3,t-4),"stroke-opacity":e.alpha*.9}):e.dashedBorder.attr({"stroke-opacity":0}),a?(e.label.show(),u&&t<70||!u&&t<40?(e.label.find(".desc").hide(),e.label2.show()):(e.label.find(".desc").show(),e.label2.hide())):(e.label.hide(),e.label2.show()),p=u?o+t*.77-e.label.height():o-e.label.height()*.5,e.label.css({width:(u?t*1.2:2*t)+"px",opacity:e.alpha}),e.label.css({left:(u?s-t*.6:s-t)+"px",top:p+"px"});var d=Math.max(80,3*t);e.label2.css({width:d+"px",opacity:e.alpha}),e.label2.css({left:s-d*.5+"px",top:o+t+"px"});if(e.hasIcon)if(u){c=(t-(a?e.label.height()*.5:0))/60;for(f in e.iconPaths)l=e.iconPaths[f],Raphael.version[0]=="1"?h="scale("+c+") translate("+s/c+", "+(o+(a?e.label.height()*-0.5:0))/c+")":h="scale("+c+") translate("+(s/c-50)+", "+((o+(a?e.label.height()*-0.5:0))/c-50)+")",l.node.setAttribute("transform",h),l.attr({"fill-opacity":e.alpha})}else for(f in e.iconPaths)l=e.iconPaths[f],l.attr({"fill-opacity":0})},a.hide=function(){var e=this,t;e.circle.remove(),e.dashedBorder.remove(),e.label.remove(),e.label2.remove(),e.visible=!1,e.hasIcon&&e.removeIcon(),e.overlay&&e.overlay.remove()},a.onclick=function(e){var t=this;t.bc.onNodeClick(t.node),t.bc.navigateTo(t.node)},a.onhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},e.type="SHOW",e.target=t,t.bc.tooltip(e)},a.onunhover=function(e){var t=this,n=t.bc.$container[0];e.node=t.node,e.type="HIDE",e.target=t,e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.origEvent.pageX-n.offsetLeft,y:e.origEvent.pageY-n.offsetTop},t.bc.tooltip(e)},a.init()};